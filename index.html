<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Recent notable bird sightings</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>
  <script src="ebird_map.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .floating-sync-button{
      position:fixed;
      width:40px;
      height:40px;
      bottom:40px;
      right:40px;
      color:#FFF;
      border-radius:50px;
      text-align:center;
    }
    .floating-sync-button-loading{ background-color:#AAA; }
    .floating-sync-button-loaded{ background-color:#228B22; box-shadow:2px 2px 3px #999; }
    .floating-sync-button-text{ margin-top:12px; }
    .mapboxgl-popup-content {
      overflow-y: scroll;
      max-height: 400px;
    }
    .filter-ctrl {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1;
      width: 250px;
    }
    </style>
  </head>
  <body>
    <div class="filter-ctrl">
      <input id="filter-days" type="range" min="0" max="7" value="7" class="slider">
      <span id="days-to-search"></span><br/>
    </div>
    <div id="map"></div>
    <a href="#" class="floating-sync-button floating-sync-button-loading fa-spin" id="refresh">
      <span class="fa fa-sync floating-sync-button-text"></span>
    </a>
    <script>
      // UI elements
      var filter_days = document.getElementById("filter-days");
      var days_to_search_display = document.getElementById("days-to-search");

      // Distance radius for finding observations
      var distance_radius = 100;

      var map;
      document.addEventListener('DOMContentLoaded', function() {
        // Map to show all observations
         map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/mapbox/light-v9",
          center: [0, 0],
          zoom: 8
        });

        map.on("load", function() {
          map.addSource("ebird-sightings", {"type": "geojson", "data": {"type": "FeatureCollection", "features": []}});
          map.addLayer({
            "id": "points",
            "type": "circle",
            "source": "ebird-sightings",
            "paint": {
              "circle-opacity" : {
                "base": 0.0,
                "stops": [[8, 0.5], [12, 0.5], [13, 1.0]]
              },
              "circle-radius": {
                "base": 2,
                "stops": [[8, 2], [11, 6], [22, 180]]
              },
              "circle-color": [
                "match",
                ["get", "time_ago_category"],
                "today", "green",
                "yesterday", "orange",
                "old", "red", "black"
              ]
            }
          });

          map.addLayer({
            "id": "points-labels",
            "type": "symbol",
            "source": "ebird-sightings",
            "layout": {
              "icon-allow-overlap": true,
              "icon-image": "circle-stroked-11",
              "text-field": "{title}",
              "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
              "text-offset": [0, 0.6],
              "text-size": 12,
              "text-anchor": "top",
            },
            "paint": {
              "icon-color":"#9fcb3b"
            }
          });

          // Set a popup to appear when a point is clicked.
          map.on("click", "points", function (e) {
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.description;
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            new mapboxgl.Popup().setLngLat(coordinates).setHTML(description).addTo(map);
          });
    
          // Show search radius
          map.addSource("search-radius-points", {
            "type": "geojson",
            "data": {
              "type": "Feature",
              "geometry": {
                "type": "Polygon",
                "coordinates": [[]]
              }
            }
          });
          map.addLayer({
            "id": "search-radius",
            "type": "line",
            "source": "search-radius-points",
            "paint": {
              "line-opacity" : 0.2
            }
          });
          
          // Get the current location and initialize map
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => set_up_map(position.coords.longitude, position.coords.latitude));
          } else {
            set_up_map(0, 0);
          }

          // Display appropriate text when the number of days is changed.
          filter_days.oninput = function() {
            if (filter_days.value == 0) {
              days_to_search_display.innerHTML = "Today only";
            } else if (filter_days.value == 1) {
              days_to_search_display.innerHTML = "Since yesterday";
            } else {
              days_to_search_display.innerHTML = "Last " + filter_days.value + " days";
            }
            update_map(map);
          };
          days_to_search_display.innerHTML = filter_days.value + " days";
        });
      }, false);

      // Set up the map.
      function set_up_map(lon, lat) {
        map.jumpTo({center: [lon, lat]});
        load_ebird_data();
      }
  
      // Draw a circle of the appropriate radius at the appropriate location.
      function update_radius_circle(lnglat) {
        let lng_rad = lnglat.lng * Math.PI / 180
        let lat_rad = lnglat.lat * Math.PI / 180
        let distance_radians = distance_radius / 6356
        let radius_points = []
        for (i = 0; i <= 100; i++) {
          let angle = 2 * Math.PI * i / 100;
          let newlat = Math.asin(Math.sin(lat_rad) * Math.cos(distance_radians) + Math.cos(lat_rad) * Math.sin(distance_radians) * Math.cos(angle))
          let newlon = lng_rad + Math.atan2(Math.sin(angle) * Math.sin(distance_radians) * Math.cos(lat_rad), Math.cos(distance_radians) - Math.sin(lat_rad) * Math.sin(newlat))
          radius_points.push([newlon * 180 / (Math.PI), newlat * 180 / (Math.PI)])
        }
        map.getSource("search-radius-points").setData({"type": "Feature", "geometry": {"type": "Polygon", "coordinates" : [radius_points]}});
      }

      // Load new eBird data to display.
      function load_ebird_data() {
        let request = new XMLHttpRequest();
        let lnglat = map.getCenter();
        let refresh_button = document.getElementById("refresh");
        request.addEventListener("load", function() {
          set_data_points(JSON.parse(request.responseText));
          update_map(map);
          refresh_button.classList.remove("floating-sync-button-loading");
          refresh_button.classList.add("floating-sync-button-loaded");
          refresh_button.classList.remove("fa-spin");
          update_radius_circle(lnglat);
        });
        refresh_button.classList.remove("floating-sync-button-loaded");
        refresh_button.classList.add("floating-sync-button-loading");
        refresh_button.classList.add("fa-spin");
        request.open("GET", "https://api.ebird.org/v2/data/obs/geo/recent/notable?lat=" + lnglat.lat + "&lng=" + lnglat.lng + "&sppLocale=en&detail=full&back=7&dist=" + distance_radius);
        request.setRequestHeader("X-eBirdApiToken", "***REMOVED***");
        request.send();
      }

      // Load new eBird data when the refresh button is clicked.
      document.getElementById("refresh").onclick = load_ebird_data;
    </script>
  </body>
</html>
